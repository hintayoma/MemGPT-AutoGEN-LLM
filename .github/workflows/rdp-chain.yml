name: RDP Node Chain

on:
  workflow_dispatch:
    inputs:
      NODE:
        description: 'Node ID'
        required: true

jobs:
  node:
    runs-on: windows-latest
    timeout-minutes: 20

    steps:
    - name: ⬇️ Checkout repo
      uses: actions/checkout@v4

    - name: 🔁 Set Node ID
      run: echo "NODE_ID=${{ github.event.inputs.NODE }}" >> $env:GITHUB_ENV

    - name: 🔐 Set secrets
      run: |
        echo "NGROK_AUTH_TOKEN=${{ secrets.NGROK_AUTH_TOKEN }}" >> $env:GITHUB_ENV
        echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $env:GITHUB_ENV

    - name: 📁 Create Data Folder
      run: mkdir "$env:USERPROFILE\Desktop\Data"

    - name: 📥 Download previous tunnel if not Node 1
      if: ${{ github.event.inputs.NODE != '1' }}
      uses: actions/download-artifact@v4
      with:
        name: tunnel-${{ github.event.inputs.NODE | fromJson | sub(1) }}
        path: ${{ env.USERPROFILE }}\Desktop

    - name: 🚀 Run RDP Setup
      run: powershell -ExecutionPolicy Bypass -File .\rdp.ps1

    - name: 📤 Upload tunnel artifact
      uses: actions/upload-artifact@v4
      with:
        name: tunnel-${{ github.event.inputs.NODE }}
        path: ${{ env.USERPROFILE }}\Desktop\tunnel-${{ github.event.inputs.NODE }}.txt
        retention-days: 1
